<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoPlay - Emotion-Based Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.1/dist/face-landmarks-detection.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #ff9e00;
            --danger: #f94144;
            --light: #f8f9fa;
            --dark: #1e1e2c;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-dark));
            --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--accent));
            --gradient-warning: linear-gradient(135deg, var(--warning), #ff6b00);
            --gradient-danger: linear-gradient(135deg, var(--danger), #d90429);
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            background: var(--gradient-primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        nav a {
            text-decoration: none;
            color: var(--light-gray);
            font-weight: 500;
            transition: var(--transition);
            position: relative;
            padding: 8px 0;
        }

        nav a:hover, nav a.active {
            color: var(--primary-light);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 3px;
        }

        .user-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius-sm);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card {
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 16px;
            color: var(--light-gray);
            font-weight: 500;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: var(--shadow);
        }

        .icon-emotion {
            background: var(--gradient-secondary);
        }

        .icon-music {
            background: var(--gradient-primary);
        }

        .icon-mood {
            background: var(--gradient-warning);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-change {
            font-size: 14px;
            color: var(--light-gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .positive {
            color: #2ecc71;
        }

        .negative {
            color: var(--danger);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .emotion-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--light);
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        #video {
            width: 100%;
            border-radius: var(--border-radius);
            transform: scaleX(-1); /* Mirror the video */
            display: block;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .emotion-display {
            text-align: center;
            margin: 20px 0;
        }

        .emotion-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .emotion-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .emotion-confidence {
            font-size: 16px;
            color: var(--light-gray);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }

        .player-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .album-art {
            width: 120px;
            height: 120px;
            border-radius: var(--border-radius);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: var(--shadow);
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .track-artist {
            font-size: 16px;
            color: var(--light-gray);
            margin-bottom: 10px;
        }

        .track-album {
            font-size: 14px;
            color: var(--gray);
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            width: 30%;
            transition: width 0.3s ease;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--light-gray);
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }

        .control-btn {
            background: transparent;
            border: none;
            color: var(--light);
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .play-btn {
            background: var(--gradient-primary);
            width: 60px;
            height: 60px;
            font-size: 28px;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .playlist-section {
            margin-top: 25px;
        }

        .playlist-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .playlist {
            max-height: 200px;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-item.active {
            background: rgba(67, 97, 238, 0.2);
        }

        .playlist-item img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-track {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--light-gray);
        }

        .mood-history {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .history-chart {
            height: 200px;
            margin-top: 20px;
        }

        .emotion-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .emotion-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .happy { background-color: #f72585; }
        .sad { background-color: #4361ee; }
        .angry { background-color: #f94144; }
        .surprised { background-color: #ff9e00; }
        .fearful { background-color: #7209b7; }
        .disgusted { background-color: #4cc9f0; }
        .neutral { background-color: #6c757d; }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            color: var(--gray);
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            nav ul {
                display: none;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-music"></i></div>
                EmoPlay
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="active">Player</a></li>
                    <li><a href="#">Playlists</a></li>
                    <li><a href="#">Mood History</a></li>
                    <li><a href="#">Settings</a></li>
                </ul>
            </nav>
            <div class="user-actions">
                <button class="btn btn-outline" id="spotifyLogin" style="display: none;"><i class="fab fa-spotify"></i> Connect Spotify</button>
                <button class="btn btn-outline" id="spotifyLogout" style="display: none;"><i class="fab fa-spotify"></i> Disconnect</button>
                <button class="btn btn-outline"><i class="fas fa-user"></i> Profile</button>
                <button class="btn btn-primary"><i class="fas fa-sliders-h"></i> Customize</button>
            </div>
        </header>

        <div class="dashboard">
            <div class="card stat-card">
                <div class="stat-header">
                    <div class="stat-title">Current Emotion</div>
                    <div class="stat-icon icon-emotion"><i class="fas fa-smile"></i></div>
                </div>
                <div class="stat-value">Happy</div>
                <div class="stat-change positive"><i class="fas fa-arrow-up"></i> 85% confidence</div>
            </div>
            <div class="card stat-card">
                <div class="stat-header">
                    <div class="stat-title">Songs Played</div>
                    <div class="stat-icon icon-music"><i class="fas fa-headphones"></i></div>
                </div>
                <div class="stat-value">24</div>
                <div class="stat-change">Today</div>
            </div>
            <div class="card stat-card">
                <div class="stat-header">
                    <div class="stat-title">Mood Stability</div>
                    <div class="stat-icon icon-mood"><i class="fas fa-chart-line"></i></div>
                </div>
                <div class="stat-value">72%</div>
                <div class="stat-change positive"><i class="fas fa-arrow-up"></i> 8% from yesterday</div>
            </div>
        </div>

        <div class="main-content">
            <div class="emotion-section">
                <div class="section-header">
                    <div class="section-title">Emotion Detection</div>
                    <div class="actions">
                        <button class="btn btn-outline" id="toggleCamera"><i class="fas fa-camera"></i> Toggle Camera</button>
                    </div>
                </div>
                
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                
                <div class="emotion-display">
                    <div class="emotion-icon">üòä</div>
                    <div class="emotion-text">Happy</div>
                    <div class="emotion-confidence">85% confidence</div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" id="startDetection"><i class="fas fa-play"></i> Start Detection</button>
                    <button class="btn btn-outline" id="stopDetection" disabled><i class="fas fa-stop"></i> Stop Detection</button>
                    <button class="btn btn-outline" id="testAudio"><i class="fas fa-volume-up"></i> Test Audio</button>
                </div>
                
                <div class="emotion-legend">
                    <div class="emotion-item">
                        <div class="color-box happy"></div>
                        <span>Happy</span>
                    </div>
                    <div class="emotion-item">
                        <div class="color-box sad"></div>
                        <span>Sad</span>
                    </div>
                    <div class="emotion-item">
                        <div class="color-box angry"></div>
                        <span>Angry</span>
                    </div>
                    <div class="emotion-item">
                        <div class="color-box surprised"></div>
                        <span>Surprised</span>
                    </div>
                    <div class="emotion-item">
                        <div class="color-box fearful"></div>
                        <span>Fearful</span>
                    </div>
                    <div class="emotion-item">
                        <div class="color-box neutral"></div>
                        <span>Neutral</span>
                    </div>
                </div>
            </div>
            
            <div class="player-section">
                <div class="section-header">
                    <div class="section-title">Now Playing</div>
                    <div class="actions">
                        <button class="btn btn-outline"><i class="fas fa-random"></i> Shuffle</button>
                    </div>
                </div>
                
                <div class="now-playing">
                    <div class="album-art">
                        <i class="fas fa-music"></i>
                    </div>
                    <div class="track-info">
                        <div class="track-title">Good Vibrations</div>
                        <div class="track-artist">The Beach Boys</div>
                        <div class="track-album">Smiley Smile ‚Ä¢ 1967</div>
                    </div>
                </div>
                
                <div class="player-controls">
                    <div class="progress-bar">
                        <div class="progress" id="songProgress"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">1:24</span>
                        <span id="totalTime">3:45</span>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn"><i class="fas fa-step-backward"></i></button>
                        <button class="control-btn play-btn"><i class="fas fa-play" id="playIcon"></i></button>
                        <button class="control-btn"><i class="fas fa-step-forward"></i></button>
                    </div>
                </div>
                
                <div class="playlist-section">
                    <div class="playlist-title">Recommended for "Happy" mood</div>
                    <div class="playlist">
                        <div class="playlist-item active">
                            <i class="fas fa-play"></i>
                            <div class="playlist-info">
                                <div class="playlist-track">Good Vibrations</div>
                                <div class="playlist-artist">The Beach Boys</div>
                            </div>
                            <span>3:45</span>
                        </div>
                        <div class="playlist-item">
                            <i class="fas fa-music"></i>
                            <div class="playlist-info">
                                <div class="playlist-track">Happy</div>
                                <div class="playlist-artist">Pharrell Williams</div>
                            </div>
                            <span>3:53</span>
                        </div>
                        <div class="playlist-item">
                            <i class="fas fa-music"></i>
                            <div class="playlist-info">
                                <div class="playlist-track">Can't Stop the Feeling!</div>
                                <div class="playlist-artist">Justin Timberlake</div>
                            </div>
                            <span>3:56</span>
                        </div>
                        <div class="playlist-item">
                            <i class="fas fa-music"></i>
                            <div class="playlist-info">
                                <div class="playlist-track">Walking on Sunshine</div>
                                <div class="playlist-artist">Katrina and the Waves</div>
                            </div>
                            <span>3:59</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mood-history">
            <div class="section-header">
                <div class="section-title">Mood History</div>
                <div class="actions">
                    <button class="btn btn-outline"><i class="fas fa-calendar"></i> Last 7 days</button>
                </div>
            </div>
            <div class="history-chart">
                <canvas id="moodChart"></canvas>
            </div>
        </div>
        
        <div class="card" style="margin-top: 30px; background: rgba(255, 255, 255, 0.05); border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="section-header">
                <div class="section-title">Spotify API Setup</div>
            </div>
            <div style="color: var(--light-gray); line-height: 1.6;">
                <p>‚úÖ <strong>Spotify API is configured!</strong> Your Client ID has been set up.</p>
                <ol style="margin: 15px 0; padding-left: 20px;">
                    <li>‚úÖ Client ID configured: <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">c7e248ca906749858da6afdc07adb089</code></li>
                    <li>Add these redirect URIs to your Spotify app settings:
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">http://localhost:3000</code></li>
                            <li><code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">http://localhost:3000/</code></li>
                            <li><code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">file:///</code> (for local file access)</li>
                        </ul>
                        <p style="font-size: 12px; color: var(--gray); margin: 5px 0;">Check the browser console to see the exact redirect URI being used.</p>
                    </li>
                    <li>Make sure your Spotify app has the required scopes enabled</li>
                </ol>
                <p style="margin-top: 15px; font-size: 14px; color: var(--success);">
                    <i class="fas fa-check-circle"></i> Ready to connect to Spotify! Click "Connect Spotify" to start.
                </p>
                <div style="margin-top: 15px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                    <p style="margin: 0; font-size: 14px; color: var(--warning);">
                        <i class="fas fa-exclamation-triangle"></i> <strong>No Sound?</strong> 
                        Click "Test Audio" to check if your browser supports audio. 
                        For Spotify music, you need a Premium subscription and proper setup.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px; background: rgba(255, 255, 255, 0.05); border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="section-header">
                <div class="section-title">Debug Information</div>
            </div>
            <div id="debugInfo" style="color: var(--light-gray); font-family: monospace; font-size: 12px; line-height: 1.4;">
                <div>Spotify SDK Status: <span id="sdkStatus">Loading...</span></div>
                <div>Access Token: <span id="tokenStatus">Not connected</span></div>
                <div>Device ID: <span id="deviceStatus">Not ready</span></div>
                <div>Player Status: <span id="playerStatus">Not initialized</span></div>
            </div>
            <button class="btn btn-outline" onclick="updateDebugInfo()" style="margin-top: 15px;">
                <i class="fas fa-refresh"></i> Refresh Status
            </button>
            <button class="btn btn-outline" onclick="showTokenInput()" style="margin-top: 10px;">
                <i class="fas fa-key"></i> Manual Token Input
            </button>
        </div>
        
        <footer>
            <p>EmoPlay Emotion-Based Music Player &copy; 2023. Music that understands how you feel.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // Spotify API Configuration
        const SPOTIFY_CLIENT_ID = 'c7e248ca906749858da6afdc07adb089';
        const SPOTIFY_REDIRECT_URI = window.location.origin + window.location.pathname;
        const SPOTIFY_SCOPES = 'user-read-private user-read-email user-top-read user-read-playback-state user-modify-playback-state user-read-currently-playing';
        
        // Debug: Log the redirect URI being used
        console.log('Current redirect URI:', SPOTIFY_REDIRECT_URI);
        
        // DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startDetection');
        const stopBtn = document.getElementById('stopDetection');
        const toggleCameraBtn = document.getElementById('toggleCamera');
        const playBtn = document.querySelector('.play-btn');
        const playIcon = document.getElementById('playIcon');
        const songProgress = document.getElementById('songProgress');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const ctx = canvas.getContext('2d');
        
        // Emotion detection variables
        let isDetecting = false;
        let detectionInterval;
        let currentEmotion = 'happy';
        let emotionConfidence = 85;
        
        // Music player variables
        let isPlaying = false;
        let currentSongTime = 84; // in seconds
        let totalSongTime = 225; // in seconds
        let audioPlayer = null; // Fallback audio player
        
        // Spotify variables
        let spotifyAccessToken = null;
        let spotifyPlayer = null;
        let spotifyDeviceId = null;
        let currentTrack = null;
        
        // Emotion to music genre mapping
        const emotionToGenres = {
            happy: ['pop', 'dance', 'upbeat', 'indie-pop', 'funk'],
            sad: ['blues', 'indie', 'folk', 'soul', 'alternative'],
            angry: ['rock', 'metal', 'punk', 'hardcore', 'grunge'],
            surprised: ['experimental', 'electronic', 'progressive', 'psychedelic', 'avant-garde'],
            fearful: ['ambient', 'dark-ambient', 'drone', 'minimal', 'atmospheric'],
            neutral: ['ambient', 'classical', 'jazz', 'chill', 'lo-fi']
        };
        
        // Set canvas size to match video
        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        
        // Spotify Authentication
        function getSpotifyAuthUrl() {
            const params = new URLSearchParams({
                client_id: SPOTIFY_CLIENT_ID,
                response_type: 'token',
                redirect_uri: SPOTIFY_REDIRECT_URI,
                scope: SPOTIFY_SCOPES,
                show_dialog: true
            });
            return `https://accounts.spotify.com/authorize?${params.toString()}`;
        }
        
        function handleSpotifyAuth() {
            console.log('Checking for Spotify authentication...');
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            const error = params.get('error');
            
            console.log('URL hash:', hash);
            console.log('Access token found:', !!accessToken);
            console.log('Error:', error);
            
            if (error) {
                console.error('Spotify auth error:', error);
                alert('Spotify authentication failed: ' + error);
                return;
            }
            
            if (accessToken) {
                console.log('Access token received!');
                spotifyAccessToken = accessToken;
                localStorage.setItem('spotify_token', accessToken);
                alert('‚úÖ Spotify connected successfully! Token saved.');
                initializeSpotifyPlayer();
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (localStorage.getItem('spotify_token')) {
                console.log('Using saved token from localStorage');
                spotifyAccessToken = localStorage.getItem('spotify_token');
                alert('‚úÖ Using saved Spotify token');
                initializeSpotifyPlayer();
            } else {
                console.log('No token found - user needs to authenticate');
            }
        }
        
        function initializeSpotifyPlayer() {
            if (!spotifyAccessToken) {
                console.log('No Spotify access token available');
                return;
            }
            
            console.log('Initializing Spotify Player...');
            
            // Check if Spotify SDK is loaded
            if (typeof Spotify === 'undefined') {
                console.error('Spotify Web Playback SDK not loaded');
                return;
            }
            
            try {
                spotifyPlayer = new Spotify.Player({
                    name: 'EmoPlay - Emotion Music Player',
                    getOAuthToken: cb => { 
                        console.log('Getting OAuth token...');
                        cb(spotifyAccessToken); 
                    },
                    volume: 0.5
                });
                
                // Error handling
                spotifyPlayer.addListener('initialization_error', ({ message }) => {
                    console.error('Failed to initialize Spotify Player:', message);
                    alert('Failed to initialize Spotify Player: ' + message);
                });
                
                spotifyPlayer.addListener('authentication_error', ({ message }) => {
                    console.error('Failed to authenticate with Spotify:', message);
                    alert('Spotify authentication failed: ' + message);
                    // Redirect to login
                    window.location.href = getSpotifyAuthUrl();
                });
                
                spotifyPlayer.addListener('account_error', ({ message }) => {
                    console.error('Failed to validate Spotify account:', message);
                    alert('Spotify account error: ' + message);
                });
                
                spotifyPlayer.addListener('playback_error', ({ message }) => {
                    console.error('Failed to perform playback:', message);
                    alert('Playback error: ' + message);
                });
                
                // Playback status updates
                spotifyPlayer.addListener('player_state_changed', state => {
                    console.log('Player state changed:', state);
                    if (!state) return;
                    
                    currentTrack = state.track_window.current_track;
                    updateNowPlayingDisplay(currentTrack);
                    
                    isPlaying = !state.paused;
                    playIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
                    
                    // Update progress
                    if (state.position && state.duration) {
                        currentSongTime = Math.floor(state.position / 1000);
                        totalSongTime = Math.floor(state.duration / 1000);
                        updateProgressBar();
                    }
                });
                
                // Ready
                spotifyPlayer.addListener('ready', ({ device_id }) => {
                    console.log('Spotify Player is ready with Device ID:', device_id);
                    spotifyDeviceId = device_id;
                    alert('Spotify Player is ready! You can now play music.');
                });
                
                // Not Ready
                spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                    console.log('Spotify Player has gone offline', device_id);
                    alert('Spotify Player went offline');
                });
                
                // Connect to the player
                spotifyPlayer.connect();
                console.log('Spotify Player connection initiated...');
                
            } catch (error) {
                console.error('Error creating Spotify Player:', error);
                alert('Error creating Spotify Player: ' + error.message);
            }
        }
        
        // Spotify API functions
        async function searchSpotifyTracks(query, limit = 10) {
            if (!spotifyAccessToken) {
                console.error('No Spotify access token available');
                return [];
            }
            
            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=${limit}`, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.tracks.items;
            } catch (error) {
                console.error('Error searching Spotify:', error);
                return [];
            }
        }
        
        async function getRecommendations(emotion, limit = 10) {
            if (!spotifyAccessToken) {
                console.error('No Spotify access token available');
                return [];
            }
            
            const genres = emotionToGenres[emotion] || emotionToGenres.neutral;
            const seedGenres = genres.slice(0, 3).join(',');
            
            // Map emotions to audio features
            const audioFeatures = getAudioFeaturesForEmotion(emotion);
            
            try {
                const params = new URLSearchParams({
                    seed_genres: seedGenres,
                    limit: limit.toString(),
                    ...audioFeatures
                });
                
                const response = await fetch(`https://api.spotify.com/v1/recommendations?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.tracks;
            } catch (error) {
                console.error('Error getting recommendations:', error);
                return [];
            }
        }
        
        function getAudioFeaturesForEmotion(emotion) {
            const features = {
                happy: { valence: 0.8, energy: 0.8, danceability: 0.8 },
                sad: { valence: 0.2, energy: 0.3, danceability: 0.3 },
                angry: { valence: 0.3, energy: 0.9, danceability: 0.4 },
                surprised: { valence: 0.6, energy: 0.7, danceability: 0.6 },
                fearful: { valence: 0.2, energy: 0.2, danceability: 0.2 },
                neutral: { valence: 0.5, energy: 0.5, danceability: 0.5 }
            };
            
            return features[emotion] || features.neutral;
        }
        
        async function playSpotifyTrack(trackUri) {
            console.log('Attempting to play track:', trackUri);
            
            if (!spotifyAccessToken) {
                console.error('No Spotify access token available');
                alert('Please connect to Spotify first');
                return;
            }
            
            if (!spotifyDeviceId) {
                console.error('Spotify device not ready');
                alert('Spotify player is not ready. Please wait a moment and try again.');
                return;
            }
            
            try {
                console.log('Sending play request to Spotify API...');
                const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: [trackUri]
                    })
                });
                
                console.log('Spotify API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Spotify API error response:', errorText);
                    throw new Error(`Failed to play track: ${response.status} - ${errorText}`);
                }
                
                console.log('Track play request successful');
                alert('Playing track: ' + trackUri);
                
            } catch (error) {
                console.error('Error playing track:', error);
                alert('Error playing track: ' + error.message);
            }
        }
        
        function updateNowPlayingDisplay(track) {
            if (!track) return;
            
            document.querySelector('.track-title').textContent = track.name;
            document.querySelector('.track-artist').textContent = track.artists[0].name;
            document.querySelector('.track-album').textContent = `${track.album.name} ‚Ä¢ ${new Date(track.album.release_date).getFullYear()}`;
            
            // Update album art
            const albumArt = document.querySelector('.album-art');
            if (track.album.images[0]) {
                albumArt.style.backgroundImage = `url(${track.album.images[0].url})`;
                albumArt.style.backgroundSize = 'cover';
                albumArt.style.backgroundPosition = 'center';
                albumArt.innerHTML = '';
            } else {
                albumArt.style.backgroundImage = '';
                albumArt.innerHTML = '<i class="fas fa-music"></i>';
            }
        }
        
        // Initialize camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 500, height: 500 } 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    resizeCanvas();
                };
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("Could not access your camera. Please check permissions.");
            }
        }
        
        // Simulate emotion detection (in a real app, this would use TensorFlow.js)
        function detectEmotion() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw a face bounding box (simulated)
            ctx.strokeStyle = '#f72585';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.rect(canvas.width * 0.25, canvas.height * 0.2, canvas.width * 0.5, canvas.height * 0.6);
            ctx.stroke();
            
            // Draw facial points (simulated)
            ctx.fillStyle = '#4361ee';
            const points = [
                [0.35, 0.3], [0.65, 0.3],  // Eyes
                [0.5, 0.5],                 // Nose
                [0.4, 0.7], [0.6, 0.7]      // Mouth corners (smile for happy)
            ];
            
            points.forEach(point => {
                ctx.beginPath();
                ctx.arc(
                    canvas.width * point[0], 
                    canvas.height * point[1], 
                    5, 0, Math.PI * 2
                );
                ctx.fill();
            });
            
            // Simulate emotion detection with weighted random results
            // In a real app, this would come from the ML model
            const emotions = [
                { name: 'happy', weight: 0.4, icon: 'üòä', color: '#f72585' },
                { name: 'sad', weight: 0.2, icon: 'üò¢', color: '#4361ee' },
                { name: 'angry', weight: 0.1, icon: 'üò†', color: '#f94144' },
                { name: 'surprised', weight: 0.1, icon: 'üò≤', color: '#ff9e00' },
                { name: 'fearful', weight: 0.1, icon: 'üò®', color: '#7209b7' },
                { name: 'neutral', weight: 0.1, icon: 'üòê', color: '#6c757d' }
            ];
            
            // Weighted random selection
            let random = Math.random();
            let selectedEmotion = emotions[0];
            
            for (const emotion of emotions) {
                if (random < emotion.weight) {
                    selectedEmotion = emotion;
                    break;
                }
                random -= emotion.weight;
            }
            
            // Occasionally keep the same emotion for continuity
            if (Math.random() > 0.7) {
                selectedEmotion = emotions.find(e => e.name === currentEmotion) || selectedEmotion;
            }
            
            currentEmotion = selectedEmotion.name;
            emotionConfidence = Math.floor(Math.random() * 20) + 75; // 75-95% confidence
            
            // Update UI
            updateEmotionDisplay(selectedEmotion);
            updateRecommendedPlaylist(selectedEmotion.name);
            
            // Play emotion-based audio tone
            if (isPlaying) {
                playEmotionTone(selectedEmotion.name);
            }
        }
        
        // Update emotion display
        function updateEmotionDisplay(emotion) {
            document.querySelector('.emotion-icon').textContent = emotion.icon;
            document.querySelector('.emotion-text').textContent = emotion.name.charAt(0).toUpperCase() + emotion.name.slice(1);
            document.querySelector('.emotion-confidence').textContent = `${emotionConfidence}% confidence`;
            
            // Update stats card
            document.querySelector('.stat-value').textContent = emotion.name.charAt(0).toUpperCase() + emotion.name.slice(1);
            document.querySelector('.stat-change').innerHTML = `<i class="fas fa-arrow-up"></i> ${emotionConfidence}% confidence`;
            
            // Change theme color based on emotion
            document.documentElement.style.setProperty('--primary', emotion.color);
        }
        
        // Update recommended playlist based on emotion
        async function updateRecommendedPlaylist(emotion) {
            const playlistContainer = document.querySelector('.playlist');
            const playlistTitle = document.querySelector('.playlist-title');
            
            playlistTitle.textContent = `Loading recommendations for "${emotion}" mood...`;
            playlistContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--light-gray);">Loading...</div>';
            
            try {
                let tracks = [];
                
                if (spotifyAccessToken) {
                    // Get Spotify recommendations
                    tracks = await getRecommendations(emotion, 8);
                } else {
                    // Fallback to static playlists
                    tracks = getFallbackPlaylist(emotion);
                }
                
                if (tracks.length === 0) {
                    playlistContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--light-gray);">No recommendations available. Please connect to Spotify.</div>';
                    return;
                }
                
                playlistTitle.textContent = `Recommended for "${emotion}" mood`;
                playlistContainer.innerHTML = '';
                
                tracks.forEach((track, index) => {
                    const item = document.createElement('div');
                    item.className = `playlist-item ${index === 0 ? 'active' : ''}`;
                    
                    // Handle both Spotify track objects and fallback objects
                    const title = track.name || track.title;
                    const artist = track.artists ? track.artists[0].name : track.artist;
                    const duration = track.duration_ms ? formatDuration(track.duration_ms) : track.time;
                    const image = track.album?.images?.[0]?.url || null;
                    
                    item.innerHTML = `
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; ${image ? `background-image: url(${image}); background-size: cover; background-position: center;` : ''}">
                            ${!image ? '<i class="fas fa-music"></i>' : ''}
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-track">${title}</div>
                            <div class="playlist-artist">${artist}</div>
                        </div>
                        <span>${duration}</span>
                    `;
                    
                    item.addEventListener('click', async () => {
                        document.querySelectorAll('.playlist-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Update now playing display
                        document.querySelector('.track-title').textContent = title;
                        document.querySelector('.track-artist').textContent = artist;
                        
                        // Play track if Spotify is available
                        if (spotifyAccessToken && track.uri) {
                            await playSpotifyTrack(track.uri);
                        } else {
                            // Fallback to simulated playback
                            currentSongTime = 0;
                            updateProgressBar();
                            if (isPlaying) {
                                playSong();
                            }
                        }
                    });
                    
                    playlistContainer.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error updating playlist:', error);
                playlistContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">Error loading recommendations</div>';
            }
        }
        
        function getFallbackPlaylist(emotion) {
            const playlists = {
                happy: [
                    { title: "Good Vibrations", artist: "The Beach Boys", time: "3:45" },
                    { title: "Happy", artist: "Pharrell Williams", time: "3:53" },
                    { title: "Can't Stop the Feeling!", artist: "Justin Timberlake", time: "3:56" },
                    { title: "Walking on Sunshine", artist: "Katrina and the Waves", time: "3:59" }
                ],
                sad: [
                    { title: "Someone Like You", artist: "Adele", time: "4:45" },
                    { title: "Hurt", artist: "Johnny Cash", time: "3:36" },
                    { title: "The Sound of Silence", artist: "Simon & Garfunkel", time: "3:05" },
                    { title: "Nothing Compares 2 U", artist: "Sinead O'Connor", time: "5:10" }
                ],
                angry: [
                    { title: "Killing in the Name", artist: "Rage Against the Machine", time: "5:14" },
                    { title: "Break Stuff", artist: "Limp Bizkit", time: "2:47" },
                    { title: "Du Hast", artist: "Rammstein", time: "3:54" },
                    { title: "Bulls on Parade", artist: "Rage Against the Machine", time: "3:49" }
                ],
                surprised: [
                    { title: "Bohemian Rhapsody", artist: "Queen", time: "5:55" },
                    { title: "Somebody That I Used to Know", artist: "Gotye", time: "4:04" },
                    { title: "Hey Ya!", artist: "OutKast", time: "3:55" },
                    { title: "Thriller", artist: "Michael Jackson", time: "5:57" }
                ],
                fearful: [
                    { title: "Fear of the Dark", artist: "Iron Maiden", time: "7:18" },
                    { title: "Runaway", artist: "Kanye West", time: "5:23" },
                    { title: "Paranoid Android", artist: "Radiohead", time: "6:27" },
                    { title: "Black Hole Sun", artist: "Soundgarden", time: "5:18" }
                ],
                neutral: [
                    { title: "Weightless", artist: "Marconi Union", time: "8:00" },
                    { title: "Clair de Lune", artist: "Claude Debussy", time: "5:03" },
                    { title: "Spiegel im Spiegel", artist: "Arvo P√§rt", time: "9:23" },
                    { title: "Ambient 1: Music for Airports", artist: "Brian Eno", time: "6:12" }
                ]
            };
            
            return playlists[emotion] || playlists.happy;
        }
        
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // Fallback audio system for when Spotify isn't available
        function createFallbackAudioPlayer() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer = null;
            }
            
            // Create a simple audio context for generating tones
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioPlayer = {
                    context: audioContext,
                    oscillator: null,
                    gainNode: null,
                    isPlaying: false,
                    
                    play: function(frequency = 440) {
                        if (this.isPlaying) return;
                        
                        this.oscillator = this.context.createOscillator();
                        this.gainNode = this.context.createGain();
                        
                        this.oscillator.connect(this.gainNode);
                        this.gainNode.connect(this.context.destination);
                        
                        this.oscillator.frequency.setValueAtTime(frequency, this.context.currentTime);
                        this.gainNode.gain.setValueAtTime(0.1, this.context.currentTime);
                        
                        this.oscillator.start();
                        this.isPlaying = true;
                    },
                    
                    pause: function() {
                        if (this.oscillator) {
                            this.oscillator.stop();
                            this.oscillator = null;
                        }
                        this.isPlaying = false;
                    },
                    
                    stop: function() {
                        this.pause();
                    }
                };
                
                return audioPlayer;
            } catch (error) {
                console.error('Could not create audio context:', error);
                return null;
            }
        }
        
        // Generate emotion-based audio tones
        function playEmotionTone(emotion) {
            if (!audioPlayer) {
                audioPlayer = createFallbackAudioPlayer();
            }
            
            if (!audioPlayer) {
                console.log('Audio not supported - this is a demo mode');
                return;
            }
            
            const emotionFrequencies = {
                happy: 523.25, // C5 - bright and cheerful
                sad: 261.63,   // C4 - lower, more somber
                angry: 880.00, // A5 - sharp and intense
                surprised: 659.25, // E5 - bright and sudden
                fearful: 220.00,   // A3 - low and ominous
                neutral: 440.00    // A4 - standard reference tone
            };
            
            const frequency = emotionFrequencies[emotion] || emotionFrequencies.neutral;
            audioPlayer.play(frequency);
        }
        
        // Stop fallback audio
        function stopFallbackAudio() {
            if (audioPlayer) {
                audioPlayer.pause();
            }
        }
        
        // Start emotion detection
        function startDetection() {
            isDetecting = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // Run detection at intervals
            detectionInterval = setInterval(detectEmotion, 2000);
            
            // Initial detection
            detectEmotion();
        }
        
        // Stop emotion detection
        function stopDetection() {
            isDetecting = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            clearInterval(detectionInterval);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // Toggle camera
        function toggleCamera() {
            if (video.style.display === 'none') {
                video.style.display = 'block';
                toggleCameraBtn.innerHTML = '<i class="fas fa-camera-slash"></i> Hide Camera';
            } else {
                video.style.display = 'none';
                toggleCameraBtn.innerHTML = '<i class="fas fa-camera"></i> Show Camera';
            }
        }
        
        // Music player functions
        async function togglePlay() {
            if (spotifyPlayer && spotifyAccessToken && spotifyDeviceId) {
                try {
            if (isPlaying) {
                        await spotifyPlayer.pause();
                    } else {
                        await spotifyPlayer.resume();
                    }
                } catch (error) {
                    console.error('Error controlling Spotify playback:', error);
                    // Fallback to audio tones
                    if (isPlaying) {
                        stopFallbackAudio();
                pauseSong();
            } else {
                        playEmotionTone(currentEmotion);
                playSong();
                    }
                }
            } else {
                // Fallback to audio tones
                if (isPlaying) {
                    stopFallbackAudio();
                    pauseSong();
                } else {
                    playEmotionTone(currentEmotion);
                    playSong();
                }
            }
        }
        
        function playSong() {
            isPlaying = true;
            playIcon.className = 'fas fa-pause';
            
            // Simulate song progress
            if (currentSongTime >= totalSongTime) {
                currentSongTime = 0;
            }
            
            // Update progress bar in real-time
            const progressInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(progressInterval);
                    return;
                }
                
                currentSongTime++;
                updateProgressBar();
                
                if (currentSongTime >= totalSongTime) {
                    clearInterval(progressInterval);
                    playNextSong();
                }
            }, 1000);
        }
        
        function pauseSong() {
            isPlaying = false;
            playIcon.className = 'fas fa-play';
        }
        
        function playNextSong() {
            const currentItem = document.querySelector('.playlist-item.active');
            const nextItem = currentItem.nextElementSibling || document.querySelector('.playlist-item');
            
            if (nextItem) {
                currentItem.classList.remove('active');
                currentItem.querySelector('i').className = 'fas fa-music';
                
                nextItem.classList.add('active');
                nextItem.querySelector('i').className = 'fas fa-play';
                
                // Update now playing
                const trackTitle = nextItem.querySelector('.playlist-track').textContent;
                const trackArtist = nextItem.querySelector('.playlist-artist').textContent;
                
                document.querySelector('.track-title').textContent = trackTitle;
                document.querySelector('.track-artist').textContent = trackArtist;
                
                // Reset player
                currentSongTime = 0;
                updateProgressBar();
                
                if (isPlaying) {
                    playSong();
                }
            }
        }
        
        function updateProgressBar() {
            const progressPercent = (currentSongTime / totalSongTime) * 100;
            songProgress.style.width = `${progressPercent}%`;
            
            // Update time display
            const currentMinutes = Math.floor(currentSongTime / 60);
            const currentSeconds = currentSongTime % 60;
            currentTimeEl.textContent = `${currentMinutes}:${currentSeconds < 10 ? '0' : ''}${currentSeconds}`;
            
            const totalMinutes = Math.floor(totalSongTime / 60);
            const totalSeconds = totalSongTime % 60;
            totalTimeEl.textContent = `${totalMinutes}:${totalSeconds < 10 ? '0' : ''}${totalSeconds}`;
        }
        
        // Initialize mood history chart
        function initMoodChart() {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const moodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Happy',
                            data: [65, 59, 70, 72, 75, 73, 80],
                            borderColor: '#f72585',
                            backgroundColor: 'rgba(247, 37, 133, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Sad',
                            data: [25, 30, 26, 22, 18, 20, 15],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Neutral',
                            data: [10, 11, 4, 6, 7, 7, 5],
                            borderColor: '#6c757d',
                            backgroundColor: 'rgba(108, 117, 125, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize the application
        async function init() {
            startBtn.addEventListener('click', startDetection);
            stopBtn.addEventListener('click', stopDetection);
            toggleCameraBtn.addEventListener('click', toggleCamera);
            playBtn.addEventListener('click', togglePlay);
            
            // Test audio button
            const testAudioBtn = document.getElementById('testAudio');
            testAudioBtn.addEventListener('click', () => {
                playEmotionTone(currentEmotion);
                alert('Playing audio tone for ' + currentEmotion + ' emotion. Check your volume!');
            });
            
            // Spotify authentication
            const spotifyLoginBtn = document.getElementById('spotifyLogin');
            const spotifyLogoutBtn = document.getElementById('spotifyLogout');
            
            spotifyLoginBtn.addEventListener('click', () => {
                window.location.href = getSpotifyAuthUrl();
            });
            
            spotifyLogoutBtn.addEventListener('click', () => {
                localStorage.removeItem('spotify_token');
                spotifyAccessToken = null;
                if (spotifyPlayer) {
                    spotifyPlayer.disconnect();
                }
                updateSpotifyUI();
                updateRecommendedPlaylist(currentEmotion);
            });
            
            // Handle Spotify authentication
            handleSpotifyAuth();
            updateSpotifyUI();
            
            // Wait for Spotify SDK to load
            if (typeof Spotify === 'undefined') {
                console.log('Waiting for Spotify SDK to load...');
                const checkSpotify = setInterval(() => {
                    if (typeof Spotify !== 'undefined') {
                        clearInterval(checkSpotify);
                        console.log('Spotify SDK loaded, initializing player...');
                        if (spotifyAccessToken) {
                            initializeSpotifyPlayer();
                        }
                    }
                }, 100);
            } else if (spotifyAccessToken) {
                initializeSpotifyPlayer();
            }
            
            await initCamera();
            initMoodChart();
            
            // Set up playlist item clicks
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.playlist-item').forEach(i => {
                        i.classList.remove('active');
                        i.querySelector('i').className = 'fas fa-music';
                    });
                    
                    this.classList.add('active');
                    this.querySelector('i').className = 'fas fa-play';
                    
                    // Update now playing
                    const trackTitle = this.querySelector('.playlist-track').textContent;
                    const trackArtist = this.querySelector('.playlist-artist').textContent;
                    
                    document.querySelector('.track-title').textContent = trackTitle;
                    document.querySelector('.track-artist').textContent = trackArtist;
                    
                    // Reset player
                    currentSongTime = 0;
                    updateProgressBar();
                    if (isPlaying) {
                        playSong();
                    }
                });
            });
        }
        
        function updateSpotifyUI() {
            const spotifyLoginBtn = document.getElementById('spotifyLogin');
            const spotifyLogoutBtn = document.getElementById('spotifyLogout');
            
            if (spotifyAccessToken) {
                spotifyLoginBtn.style.display = 'none';
                spotifyLogoutBtn.style.display = 'inline-flex';
            } else {
                spotifyLoginBtn.style.display = 'inline-flex';
                spotifyLogoutBtn.style.display = 'none';
            }
            
            updateDebugInfo();
        }
        
        function updateDebugInfo() {
            const sdkStatus = document.getElementById('sdkStatus');
            const tokenStatus = document.getElementById('tokenStatus');
            const deviceStatus = document.getElementById('deviceStatus');
            const playerStatus = document.getElementById('playerStatus');
            
            // SDK Status
            if (typeof Spotify !== 'undefined') {
                sdkStatus.textContent = '‚úÖ Loaded';
                sdkStatus.style.color = 'var(--success)';
            } else {
                sdkStatus.textContent = '‚ùå Not loaded';
                sdkStatus.style.color = 'var(--danger)';
            }
            
            // Token Status
            if (spotifyAccessToken) {
                tokenStatus.textContent = '‚úÖ Connected (' + spotifyAccessToken.substring(0, 10) + '...)';
                tokenStatus.style.color = 'var(--success)';
            } else {
                tokenStatus.textContent = '‚ùå Not connected';
                tokenStatus.style.color = 'var(--danger)';
            }
            
            // Device Status
            if (spotifyDeviceId) {
                deviceStatus.textContent = '‚úÖ Ready (' + spotifyDeviceId.substring(0, 8) + '...)';
                deviceStatus.style.color = 'var(--success)';
            } else {
                deviceStatus.textContent = '‚ùå Not ready';
                deviceStatus.style.color = 'var(--danger)';
            }
            
            // Player Status
            if (spotifyPlayer) {
                playerStatus.textContent = '‚úÖ Initialized';
                playerStatus.style.color = 'var(--success)';
            } else {
                playerStatus.textContent = '‚ùå Not initialized';
                playerStatus.style.color = 'var(--danger)';
            }
        }
        
        function showTokenInput() {
            const token = prompt('Enter your Spotify access token:\n\nTo get a token:\n1. Click "Connect Spotify" button\n2. Authorize the app\n3. Copy the token from the URL or console\n\nOr use a tool like: https://developer.spotify.com/console/get-current-user/');
            
            if (token && token.trim()) {
                spotifyAccessToken = token.trim();
                localStorage.setItem('spotify_token', spotifyAccessToken);
                alert('‚úÖ Token saved! Initializing Spotify player...');
                initializeSpotifyPlayer();
                updateSpotifyUI();
            }
        }
        
        // Start the app when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>